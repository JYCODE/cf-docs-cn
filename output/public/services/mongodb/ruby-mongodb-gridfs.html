<!DOCTYPE html>
<!--[if IE]>  <![endif]-->
<!--[if lt IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie6"> <![endif]-->
<!--[if IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie7"> <![endif]-->
<!--[if IE 8 ]> <html lang="en" dir="ltr" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]> <html lang="en" dir="ltr" class="no-js ie9"> <![endif]-->
<html lang='en' xmlns:og='http://ogp.me/ns#'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='VMware' name='author'>
<meta content='Copyright VMware 2011. All Rights Reserved.' name='copyright'>
<meta content='juhk3p2B-UhzEjLXtqFwDMVLo5Lmy4ZP-zVe7Gxo2Dw' name='google-site-verification'>
<meta content='en-us' http-equiv='Content-Language'>
<meta content='false' http-equiv='imagetoolbar'>
<meta content='true' name='MSSmartTagsPreventParsing'>
<meta content='all' name='robots'>
<meta content='147862838623179' property='fb:app_id'>
<meta content='website' property='og:type'>
<meta content='https://docs.cloudfoundry.com/services/mongodb/ruby-mongodb-gridfs.html' property='og:url'>
<meta content='https://docs.cloudfoundry.com/images/cf100.png' property='og:image'>
<meta content='Cloud Foundry | Ruby 与 MongoDB 和 GridFS 一起使用' property='og:title'>
<meta content='与 MongoDB 和 GridFS 相关的 Ruby 开发' property='og:description'>
<meta content='en_US' property='og:locale'>
<title>Cloud Foundry | Ruby 与 MongoDB 和 GridFS 一起使用</title>
<link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css'>
<link href='/stylesheets/master.css' media='screen' rel='stylesheet' type='text/css'>
<link href='favicon.ico' rel='shortcut icon'>
<link href='/stylesheets/uv_active4d.css' rel='stylesheet' type='text/css'>
<link href='/stylesheets/documentation.css' media='screen' rel='stylesheet' type='text/css'>
<link href='/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css'>
<script src='/js/jquery-1.6.4.min.js' type='text/javascript'></script>
<script src='/js/documentation.js' type='text/javascript'></script>
<script src='/js/jquery.easing.js' type='text/javascript'></script>
<script src='/js/jquery.social.share.1.2.min.js' type='text/javascript'></script>
<!--[if lt IE 9 ]> <link href="/stylesheets/ie.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<!--[if lt IE 8 ]> <link href="/stylesheets/ie7.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<link href='/stylesheets/master-cf.css' media='screen' rel='stylesheet' type='text/css'>
</head>
<body class='api'>
<div class='wrapper'>
<div class='container' id='header'>
<div class='site-wrap'>
<div class='container'>
<div class='span-6 logo-wrap'>
<!-- %a{:href => url(@config, :www_app)} -->
<a href='http://www.cloudfoundry.cn'>
<img alt="Cloud Foundry: The Industry's First Open Platform As A Service" height='70' src='/images/logo_header_cloudfoundry.png' width='373'>
<span class='replaced'>Cloud Foundry: The Industry's First Open Platform As A Service</span>
</img>
</a>
</div>
<div class='span-9 last'>
<div class='right'>
<form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input' name='q' placeholder='search' type='text' value=''>
</form>
<ul class='super-nav'>
<li>
<a href='http://my.cloudfoundry.com/signup'>注册</a>
</li>
<li>
<a href='http://my.cloudfoundry.com/micro'>下载</a>
</li>
<li>
<a href='http://support.cloudfoundry.com' rel='external' target='_blank'>支持</a>
</li>
<li>
<a href='http://status.cloudfoundry.com' target='_blank'>状态</a>
</li>
<li>
<a href='http://http://www.cloudfoundry.com' target='_blank'>英文站点</a>
</li>
</ul>
</div>
<div id='nav'>
<ul>
<li class='selected'>
<a href='http://cndocs.cloudfoundry.com'>技术文档</a>
</li>
<li>
<!-- %a{:href => "#{url(@config, :www_app)}/getinvolved"} 如何参与 -->
<a href='http://cn.cloudfoundry.com/getinvolved'>如何参与</a>
</li>
<li>
<!-- %a{:href => "#{url(@config, :www_app)}/partners"} 合作伙伴 -->
<a href='http://cn.cloudfoundry.com/partners'>合作伙伴</a>
</li>
<li>
<!-- %a{:href => url(@config, :blog_app)} 中文博客 -->
<a href='http://cnblog.cloudfoundry.com/'>中文博客</a>
</li>
<li>
<!-- %a{:href => "#{url(@config, :www_app)}/about"} 关于我们 -->
<a href='http://cn.cloudfoundry.com/about'>关于我们</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='main'>
<div class='content-wrap'>
<div class='header-wrap clearfix'>
<div class='site-wrap'>
<h1>Services</h1>
<p class='sub-head'>Ruby 与 MongoDB 和 GridFS 一起使用</p>
</div>
</div>
<div class='site-wrap'>
<div class='container content'>
<div class='span-15 prepend-top'>
<div class='span-4'>
<div class='sub-nav'>
<p>
<strong>
<a href='/getting-started.html'>Cloud Foundry入门</a>
</strong>
迅速开始使用Cloud Foundry的入门文档.
</p>
<form action='http://www.cloudfoundry.com/search' class='search-form-docs' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input-docs' name='q' placeholder='search docs' type='text' value='more:docs'>
</form>
<br>
<br>
<div class='sidebar-shell' id='js-sidebar'>
<div class='js-accordion-list sidebar-module'>
<ul>
<li class='js-topic'>
<h3>
<a href='#'>语言和编程框架</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks.html'>概述</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring.html'>Spring</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/java/spring/spring-insight.html'>Spring Insight</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/grails.html'>Grails</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/scala/scala.html'>Scala</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/scala/lift.html'>Lift</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/play/play.html'>Play</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/play/java-getting-started.html'>Java入门指南</a>
</li>
<li>
<a href='/frameworks/play/scala-getting-started.html'>Scala入门指南</a>
</li>
<li>
<a href='/frameworks/play/java-mysql.html'>在Java应用中使用MySQL</a>
</li>
<li>
<a href='/frameworks/play/java-postgresql.html'>在Java应用中使用PostgreSQL</a>
</li>
<li>
<a href='/frameworks/play/java-mongodb.html'>在Java应用中使用MongoDB</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/nodejs/nodejs.html'>Node.js</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/nodejs/nodeAutoReconfig.html'>有关自动配置</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/ruby/ruby-rails-sinatra.html'>Ruby, Rails, Sinatra</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/ruby/ruby.html'>概述</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-cf.html'>相关事宜</a>
</li>
<li>
<a href='/frameworks/ruby/installing-ruby.html'>安装 Ruby</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-simple.html'>创建应用</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-0.html'>Rails 3.0</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-1.html'>Rails 3.1</a>
</li>
<li>
<a href='/frameworks/ruby/sinatra.html'>Sinatra</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>基础架构</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/infrastructure/overview.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/infrastructure/micro/mcf.html'>MCF</a>
<ul class='js-subguides'>
<li>
<a href='/infrastructure/micro/installing-mcf.html'>安装 MCF</a>
</li>
<li>
<a href='/infrastructure/micro/using-mcf.html'>使用 MCF</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>服务</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/services.html'>概述</a>
</li>
<li class='js-subtopic'>
<a href='/services/mongodb/mongodb.html'>MongoDB</a>
<ul class='js-subguides'>
<li>
<a href='/services/mongodb/grails-mongodb.html'>Grails</a>
</li>
<li>
<a href='/services/mongodb/nodejs-mongodb.html'>Node.js</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb.html'>Ruby</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb-gridfs.html'>GridFS</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/mysql/mysql-overview.html'>MySQL</a>
<ul class='js-subguides'>
<li>
<a href='/services/mysql/mysql.html'>介绍</a>
</li>
<li>
<a href='/services/mysql/grails-mysql.html'>Grails</a>
</li>
<li>
<a href='/services/mysql/ruby-mysql.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/rabbitmq/rabbitmq.html'>RabbitMQ</a>
<ul class='js-subguides'>
<li>
<a href='/services/rabbitmq/faq-rabbitmq.html'>常见问题</a>
</li>
<li>
<a href='/services/rabbitmq/nodejs-rabbitmq.html'>Node.js</a>
</li>
<li>
<a href='/services/rabbitmq/ruby-rabbitmq.html'>Ruby</a>
</li>
<li>
<a href='/services/rabbitmq/spring-rabbitmq.html'>Spring</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/redis/redis.html'>Redis</a>
<ul class='js-subguides'>
<li>
<a href='/services/redis/ruby-redis.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/postgres/postgres.html'>vFabric Postgres</a>
<ul class='js-subguides'>
<li>
<a href='/services/postgres/postgres-ruby.html'>Ruby</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>工具</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/tools/vmc/vmc.html'>VMC</a>
<ul class='js-subguides'>
<li>
<a href='/tools/vmc/installing-vmc.html'>安装</a>
</li>
<li>
<a href='/tools/vmc/debugging.html'>应用调试</a>
</li>
<li>
<a href='/tools/vmc/vmc-quick-ref.html'>快速参考</a>
</li>
<li>
<a href='/tools/vmc/vmc-non-interactive.html'>非交互模式</a>
</li>
<li>
<a href='/tools/vmc/caldecott.html'>Caldecott隧道</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/STS/sts-eclipse.html'>STS & Eclipse</a>
<ul class='js-subguides'>
<li>
<a href='/tools/STS/configuring-STS.html'>配置</a>
</li>
<li>
<a href='/tools/STS/debugging-CF-Eclipse.html'>应用调试</a>
</li>
<li>
<a href='/tools/STS/deploying-CF-Eclipse.html'>应用部署</a>
</li>
<li>
<a href='/tools/STS/remote-CF-Eclipse.html'>远程访问</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/spring-insight.html'>Spring Insight</a>
</li>
<li class='js-subtopic'>
<a href='/tools/gallery/box.html'>Box 集成</a>
</li>
<li class='js-subtopic'>
<a href='/tools/deploying-apps.html'>部署应用</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>部署云平台</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/deploy/overview.html'>概述</a>
</li>
<li class='js-subtopic'>
<a href='/deploy/dev_setup.html'>dev_setup</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/dev_setup-Single-Node.html'>单节点dev_setup</a>
</li>
<li>
<a href='/deploy/dev_setup-Multi-Node.html'>多节点dev_setup</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/bosh.html'>什么是BOSH</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/bosh-docs.html'>BOSH文档</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/vSphere.html'>在vSphere上部署</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/vSphere-IaaS.html'>准备IaaS环境</a>
</li>
<li>
<a href='/deploy/vSphere-BOSH.html'>安装BOSH</a>
</li>
<li>
<a href='/deploy/vSphere-CF.html'>部署Cloud Foundry</a>
</li>
<li>
<a href='/deploy/vSphere-CF-mgmt.html'>管理和运维Cloud Foundry</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/OpenStack.html'>在OpenStack上部署</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/os-install.html'>OpenStack Essex安装及配置</a>
</li>
<li>
<a href='/deploy/os-prepare.html'>准备BOSH CLI虚拟机</a>
</li>
<li>
<a href='/deploy/os-micro-bosh.html'>部署Micro BOSH</a>
</li>
<li>
<a href='/deploy/os-bosh.html'>部署BOSH</a>
</li>
<li>
<a href='/deploy/os-cf.html'>部署Cloud Foundry</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/customize.html'>定制Cloud Foundry</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/customize-framework.html'>添加框架</a>
</li>
<li>
<a href='/deploy/customize-runtime.html'>添加运行时</a>
</li>
<li>
<a href='/deploy/customize-services.html'>添加系统服务</a>
</li>
<li>
<a href='/deploy/customize-php.html'>支持PHP语言</a>
</li>
<li>
<a href='/deploy/customize-python.html'>支持Python语言</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>例子</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/samples/cool-apps.html'>酷炫应用程序</a>
</li>
<li class='js-subtopic'>
<a href='/samples/samples.html'>精彩代码分析</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<strong>
<a href='/faq.html'>FAQ</a>
</strong>
常见问题.
</p>
<p>
<strong>
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' target='_blank'>Forums</a>
</strong>
加入讨论.
</p>
<p>
<strong>
<a href='http://webinars.cloudfoundry.com'>Webinars</a>
</strong>
学习更多.
</p>
</div>
</div>
<div class='span-11 last'>
<h2>与 MongoDB 和 GridFS 相关的 Ruby 开发</h2>
<p class='tags'>
<strong>Tags:</strong>
<span>
<a href="/tags/mongodb" rel="tag">mongodb</a><a href="/tags/grid-fs" rel="tag">grid-fs</a><a href="/tags/rails" rel="tag">rails</a><a href="/tags/教程" rel="tag">教程</a>
</span>
</p>
<p class='timestamp'>
<strong>Last Updated:</strong>
<span>
2012-09-28
</span>
</p>
<div id='social-share'></div>
<p>GridFS 是关于在 MongoDB 数据库中存储超过 MongoDB 大小限制的文件的技术说明。它以块方式存储文件，并通过一个 API 将文件块的集合作为一个单个对象进行管理。此教程通过添加一个头像至用户模型，演示了如何在 Rails 应用中使用 GridFS。</p>

<p>许多 Web 应用程序允许用户上传和检索生成的图像，如档案图片、相片或视频缩略图。如果您是在 Rails 上使用 Ruby，您可以使用一些很不错的框架：PaperClip 和 CarrierWave。</p>

<p>之所以为此项目选择 CarrierWave，因为它看上去是最不突出的和最灵活的。CarrierWave 可与文件系统、Amazon S3 或一个数据库（包括 Mongo GridFS）一起使用。</p>

<p>第一个任务是在用户使用 Facebook 帐户在应用程序上注册时添加图片。支持图片上传和提供下载的步骤如下。关于与 Facebook 整合的更多详细信息，请审查源代码中的 <code>user.rb</code> 模型。</p>

<h2 id="section">在您的终端上实施的步骤</h2>

<p>假设的情况是您已经在具有用户模型的 Cloud Foundry 上的 Rails 3.0 应用程序上拥有一个 Ruby。</p>

<pre class="terminal">
# Log in to Cloud Foundry if you are not logged in
$ vmc login youremail@domain.com

$ vmc create-service mongodb

# See what the newly created mongo service is called
$ vmc services

# Bind the service to your existing application
$ vmc bind-service mongodb-???? appname

</pre>

<h2 id="section-1">在您的代码库上实施的步骤</h2>

<h3 id="section-2">依赖项</h3>

<p>添加以下 gem 至您的 Gemfile</p>

<pre><code class="language-ruby"><span class="n">gem</span> <span class="s1">'carrierwave'</span>
<span class="n">gem</span> <span class="s1">'carrierwave-mongoid'</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s2">"carrierwave/mongoid"</span></code></pre>

<p>生成上传程序</p>

<pre class="terminal">
$ rails generate uploader Avatar
</pre>

<p>编辑生成文件 <code>app/uploaders/avadar_uploader.rb</code>，若要使用 grid_fs</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="nc">AvatarUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span>

    <span class="c1"># Choose what kind of storage to use for this uploader:</span>
    <span class="n">storage</span> <span class="ss">:grid_fs</span>

    <span class="c1"># Override the directory where uploaded files will be stored.</span>
    <span class="c1"># This is a sensible default for uploaders that are meant to be mounted:</span>
    <span class="k">def</span> <span class="nf">store_dir</span>
        <span class="s2">"</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">mounted_as</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>

    <span class="c1"># Provide a default URL as a default if there hasn't been a file uploaded:</span>
    <span class="k">def</span> <span class="nf">default_url</span>
        <span class="s2">"/images/fallback/"</span> <span class="o">+</span> <span class="o">[</span><span class="n">version_name</span><span class="p">,</span> <span class="s2">"default.png"</span><span class="o">].</span><span class="n">compact</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'_'</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span></code></pre>

<p>更新您的 ActiveRecord 模型以储存头像。</p>

<p>确保在装载 ORM 之后才装载 CarrierWave，否则，您将需要手动添加相关的扩展，例如：</p>

<pre><code class="language-ruby"><span class="nb">require</span> <span class="s1">'carrierwave/orm/activerecord'</span></code></pre>

<p>对您想要装入上传程序的模型添加一个字符串列。</p>

<pre class="terminal">
$ add_column :users, :avatar, :string
</pre>

<p>打开您的模型文件，添加代码以装入上传程序：</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="nc">User</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
    <span class="n">mount_uploader</span> <span class="ss">:avatar</span><span class="p">,</span> <span class="no">AvatarUploader</span>

    <span class="c1"># Make sure that the avatar is accessible</span>
    <span class="n">attr_accessible</span> <span class="ss">:emails</span><span class="p">,</span> <span class="ss">:avatar</span><span class="p">,</span> <span class="ss">:remote_avatar_url</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:last_name</span> <span class="c1">#....</span>
<span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="k">end</span></code></pre>

<p>为 Mongoid 创建初始化程序，以使用 Cloud Foundry 上的 MongoDB 实例。将其命名为 <code>01_mongoid.rb</code>，使其在所有其它程序之前运行。</p>

<pre><code class="language-ruby"><span class="no">Mongoid</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">conn_info</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">'VCAP_SERVICES'</span><span class="o">]</span>
    <span class="n">services</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">'VCAP_SERVICES'</span><span class="o">]</span><span class="p">)</span>
    <span class="n">services</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">service_version</span><span class="p">,</span> <span class="n">bindings</span><span class="o">|</span>
      <span class="n">bindings</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">binding</span><span class="o">|</span>
        <span class="k">if</span> <span class="nb">binding</span><span class="o">[</span><span class="s1">'label'</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/mongo/i</span>
          <span class="n">conn_info</span> <span class="o">=</span> <span class="nb">binding</span><span class="o">[</span><span class="s1">'credentials'</span><span class="o">]</span>
          <span class="k">break</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">raise</span> <span class="s2">"could not find connection info for mongo"</span> <span class="k">unless</span> <span class="n">conn_info</span>
  <span class="k">else</span>
    <span class="n">conn_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'hostname'</span> <span class="o">=&gt;</span> <span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'port'</span> <span class="o">=&gt;</span> <span class="mi">27017</span><span class="p">}</span>
  <span class="k">end</span>

  <span class="n">cnx</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">conn_info</span><span class="o">[</span><span class="s1">'hostname'</span><span class="o">]</span><span class="p">,</span> <span class="n">conn_info</span><span class="o">[</span><span class="s1">'port'</span><span class="o">]</span><span class="p">,</span> <span class="ss">:pool_size</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">)</span>
  <span class="n">db</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">[</span><span class="s1">'db'</span><span class="o">]</span>
  <span class="k">if</span> <span class="n">conn_info</span><span class="o">[</span><span class="s1">'username'</span><span class="o">]</span> <span class="ow">and</span> <span class="n">conn_info</span><span class="o">[</span><span class="s1">'password'</span><span class="o">]</span>
    <span class="n">db</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">conn_info</span><span class="o">[</span><span class="s1">'username'</span><span class="o">]</span><span class="p">,</span> <span class="n">conn_info</span><span class="o">[</span><span class="s1">'password'</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">db</span>
<span class="k">end</span></code></pre>

<p>更新您的 CarrierWave 初始化程序以使用 Cloud Foundry MongoDB 服务。</p>

<pre><code class="language-ruby"><span class="c1">#initializers/carrierwave.rb</span>
<span class="nb">require</span> <span class="s1">'serve_gridfs_image'</span>

<span class="no">CarrierWave</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="ss">:grid_fs</span>
  <span class="n">config</span><span class="o">.</span><span class="n">grid_fs_connection</span> <span class="o">=</span> <span class="no">Mongoid</span><span class="o">.</span><span class="n">database</span>

  <span class="c1"># Storage access url</span>
  <span class="n">config</span><span class="o">.</span><span class="n">grid_fs_access_url</span> <span class="o">=</span> <span class="s2">"/grid"</span>
<span class="k">end</span></code></pre>

<p>在 <code>lib/serve_gridfs_image.rb</code> 中处理图片请求：</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="nc">ServeGridfsImage</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
      <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env</span><span class="o">[</span><span class="s2">"PATH_INFO"</span><span class="o">]</span> <span class="o">=~</span> <span class="sr">/^\/grid\/(.+)$/</span>
      <span class="n">process_request</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="vg">$1</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">begin</span>
      <span class="no">Mongo</span><span class="o">::</span><span class="no">GridFileSystem</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Mongoid</span><span class="o">.</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
        <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="n">file</span><span class="o">.</span><span class="n">content_type</span> <span class="p">},</span> <span class="o">[</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="o">]]</span>
      <span class="k">end</span>
    <span class="k">rescue</span>
      <span class="o">[</span><span class="mi">404</span><span class="p">,</span> <span class="p">{</span> <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/plain'</span> <span class="p">},</span> <span class="o">[</span><span class="s1">'File not found.'</span><span class="o">]]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h2 id="section-3">部署</h2>

<pre class="terminal">
$ bundle install
    bundle package
    vmc update app_name
</pre>

<h2 id="section-4">总结</h2>

<p>这样您将可以上传图片和提供图片下载。务必注意它不提供改变图片大小功能。例如，若您使用的是 Devise，您可以在用户注册时导入用户的头像（档案图片）。</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">new_with_session</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
      <span class="k">super</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">[</span><span class="s1">'devise.omniauth_info'</span><span class="o">]</span>
          <span class="k">if</span> <span class="n">data</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="s1">'devise.omniauth_info'</span><span class="o">][</span><span class="s1">'user_info'</span><span class="o">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'name'</span><span class="o">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key?</span> <span class="s1">'name'</span>
            <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'email'</span><span class="o">]</span>
            <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'nickname'</span><span class="o">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key?</span> <span class="s1">'nickname'</span>
            <span class="n">user</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'first_name'</span><span class="o">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key?</span> <span class="s1">'first_name'</span>
            <span class="n">user</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'last_name'</span><span class="o">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key?</span> <span class="s1">'last_name'</span>
            <span class="n">user</span><span class="o">.</span><span class="n">remote_avatar_url</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">'image'</span><span class="o">]</span> <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key?</span> <span class="s1">'image'</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre>

<h2 id="section-5">参考</h2>

<ul>
<li><a href="http://support.cloudfoundry.com/entries/20016922-connecting-to-a-mongo-db">连接 MongoDB 数据库</a></li>
  <li><a href="https://github.com/jnicklas/carrierwave">CarrierWave</a></li>
  <li><a href="https://github.com/jnicklas/carrierwave-mongoid">CarrierWave for Mongoid</a></li>
  <li><a href="http://antekpiechnik.com/posts/setting-up-carrierwave-file-uploads-using-gridfs-on-rails-3-and-mongoid">使用 Rails 3 和 mongoid 上的 GridFS 设置 CarrierWave 文件上传</a></li>
  <li><a href="https://github.com/plataformatec/devise">Devise</a></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='footer'>
<div class='site-wrap'>
<div class='row'>
<div class='span-3 social-icons'>
<a class='twitter replaced' href='http://e.weibo.com/2169336083/profile' rel='external' target='_blank'>Weibo</a>
<a class='facebook replaced' href='http://cloudfoundry.csdn.net' rel='external' target='_blank'>CSDN</a>
<a class='youtube replaced' href='http://i.youku.com/u/id_UNDI5MTA2Mjk2' rel='external' target='_blank'>YouKu</a>
</div>
<div class='prepend-2 span-5'>
<p>
<!-- %a{:href => "#{url(@config, :www_app)}/faq"} 问题 -->
<a href='http://cndocs.cloudfoundry.com/faq.html'>问题</a>
|
<a href='http://forum.csdn.net/slist/cloudfoundry' rel='external'>论坛</a>
|
<!-- %a{:href => url(@config, :blog_app), :rel => "external"} 博客 -->
<a href='http://cnblog.cloudfoundry.com/' rel='external'>博客</a>
|
<a href='http://www.cloudfoundry.com/jobs'>工作</a>
|
<a href='http://www.cloudfoundry.com/legal'>法律</a>
|
<a href='http://www.cloudfoundry.com/terms'>条款</a>
|
<a href='http://www.vmware.com/help/privacy.html' rel='external' target='_blank'>隐私</a>
</p>
</div>
<div class='span-5 last right'>
<p>Copyright &copy; 2013 VMware, Inc. All rights reserved.</p>
</div>
</div>
</div>
</div>
<script>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-22181585-14']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    /$(document).ready(function() {
     / $('#social-share').dcSocialShare({
      /  buttonSize: 'horizontal',
      / buttons: 'facebook,twitter,plusone,linkedin',
      /  location: 'top',
      /  align: 'right',
      /  offsetLocation: 260,
      /  offsetAlign: 100,
      /  width: 80,
      /  center: true,
      /  centerPx: 600,
      /  disableFloat: true,
      /  tabText: '',
      /  twitterId: 'cloudfoundry'
      /});
    /});
  //]]>
</script>
</body>
</html>
