<!DOCTYPE html>
<!--[if IE]>  <![endif]-->
<!--[if lt IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie6"> <![endif]-->
<!--[if IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie7"> <![endif]-->
<!--[if IE 8 ]> <html lang="en" dir="ltr" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]> <html lang="en" dir="ltr" class="no-js ie9"> <![endif]-->
<html lang='en' xmlns:og='http://ogp.me/ns#'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='VMware' name='author'>
<meta content='Copyright VMware 2011. All Rights Reserved.' name='copyright'>
<meta content='juhk3p2B-UhzEjLXtqFwDMVLo5Lmy4ZP-zVe7Gxo2Dw' name='google-site-verification'>
<meta content='en-us' http-equiv='Content-Language'>
<meta content='false' http-equiv='imagetoolbar'>
<meta content='true' name='MSSmartTagsPreventParsing'>
<meta content='all' name='robots'>
<meta content='147862838623179' property='fb:app_id'>
<meta content='website' property='og:type'>
<meta content='https://docs.cloudfoundry.com/deploy/vSphere-IaaS.html' property='og:url'>
<meta content='https://docs.cloudfoundry.com/images/cf100.png' property='og:image'>
<meta content='Cloud Foundry | 准备IaaS环境' property='og:title'>
<meta content='在vSphere上通过BOSH工具大规模部署Cloud Foundry' property='og:description'>
<meta content='en_US' property='og:locale'>
<title>Cloud Foundry | 准备IaaS环境</title>
<link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css'>
<link href='/stylesheets/master.css' media='screen' rel='stylesheet' type='text/css'>
<link href='favicon.ico' rel='shortcut icon'>
<link href='/stylesheets/uv_active4d.css' rel='stylesheet' type='text/css'>
<link href='/stylesheets/documentation.css' media='screen' rel='stylesheet' type='text/css'>
<link href='/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css'>
<script src='/js/jquery-1.6.4.min.js' type='text/javascript'></script>
<script src='/js/documentation.js' type='text/javascript'></script>
<script src='/js/jquery.easing.js' type='text/javascript'></script>
<script src='/js/jquery.social.share.1.2.min.js' type='text/javascript'></script>
<!--[if lt IE 9 ]> <link href="/stylesheets/ie.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<!--[if lt IE 8 ]> <link href="/stylesheets/ie7.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<link href='/stylesheets/master-cf.css' media='screen' rel='stylesheet' type='text/css'>
</head>
<body class='api'>
<div class='wrapper'>
<div class='container' id='header'>
<div class='site-wrap'>
<div class='container'>
<div class='span-6 logo-wrap'>
<!-- %a{:href => url(@config, :www_app)} -->
<a href='http://www.cloudfoundry.cn'>
<img alt="Cloud Foundry: The Industry's First Open Platform As A Service" height='70' src='/images/logo_header_cloudfoundry.png' width='373'>
<span class='replaced'>Cloud Foundry: The Industry's First Open Platform As A Service</span>
</img>
</a>
</div>
<div class='span-9 last'>
<div class='right'>
<form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input' name='q' placeholder='search' type='text' value=''>
</form>
<ul class='super-nav'>
<li>
<a href='http://my.cloudfoundry.com/signup'>注册</a>
</li>
<li>
<a href='http://my.cloudfoundry.com/micro'>下载</a>
</li>
<li>
<a href='http://support.cloudfoundry.com' rel='external' target='_blank'>支持</a>
</li>
<li>
<a href='http://status.cloudfoundry.com' target='_blank'>状态</a>
</li>
<li>
<a href='http://http://www.cloudfoundry.com' target='_blank'>英文站点</a>
</li>
</ul>
</div>
<div id='nav'>
<ul>
<li class='selected'>
<a href='http://cndocs.cloudfoundry.com'>技术文档</a>
</li>
<li>
<!-- %a{:href => "#{url(@config, :www_app)}/getinvolved"} 如何参与 -->
<a href='http://cn.cloudfoundry.com/getinvolved'>如何参与</a>
</li>
<li>
<!-- %a{:href => "#{url(@config, :www_app)}/partners"} 合作伙伴 -->
<a href='http://cn.cloudfoundry.com/partners'>合作伙伴</a>
</li>
<li>
<!-- %a{:href => url(@config, :blog_app)} 中文博客 -->
<a href='http://cnblog.cloudfoundry.com/'>中文博客</a>
</li>
<li>
<!-- %a{:href => "#{url(@config, :www_app)}/about"} 关于我们 -->
<a href='http://cn.cloudfoundry.com/about'>关于我们</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='main'>
<div class='content-wrap'>
<div class='header-wrap clearfix'>
<div class='site-wrap'>
<h1>Deploy</h1>
<p class='sub-head'>准备IaaS环境</p>
</div>
</div>
<div class='site-wrap'>
<div class='container content'>
<div class='span-15 prepend-top'>
<div class='span-4'>
<div class='sub-nav'>
<p>
<strong>
<a href='/getting-started.html'>Cloud Foundry入门</a>
</strong>
迅速开始使用Cloud Foundry的入门文档.
</p>
<form action='http://www.cloudfoundry.com/search' class='search-form-docs' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input-docs' name='q' placeholder='search docs' type='text' value='more:docs'>
</form>
<br>
<br>
<div class='sidebar-shell' id='js-sidebar'>
<div class='js-accordion-list sidebar-module'>
<ul>
<li class='js-topic'>
<h3>
<a href='#'>语言和编程框架</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks.html'>概述</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring.html'>Spring</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/java/spring/spring-insight.html'>Spring Insight</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/grails.html'>Grails</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/scala/scala.html'>Scala</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/scala/lift.html'>Lift</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/play/play.html'>Play</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/play/java-getting-started.html'>Java入门指南</a>
</li>
<li>
<a href='/frameworks/play/scala-getting-started.html'>Scala入门指南</a>
</li>
<li>
<a href='/frameworks/play/java-mysql.html'>在Java应用中使用MySQL</a>
</li>
<li>
<a href='/frameworks/play/java-postgresql.html'>在Java应用中使用PostgreSQL</a>
</li>
<li>
<a href='/frameworks/play/java-mongodb.html'>在Java应用中使用MongoDB</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/nodejs/nodejs.html'>Node.js</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/nodejs/nodeAutoReconfig.html'>有关自动配置</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/ruby/ruby-rails-sinatra.html'>Ruby, Rails, Sinatra</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/ruby/ruby.html'>概述</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-cf.html'>相关事宜</a>
</li>
<li>
<a href='/frameworks/ruby/installing-ruby.html'>安装 Ruby</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-simple.html'>创建应用</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-0.html'>Rails 3.0</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-1.html'>Rails 3.1</a>
</li>
<li>
<a href='/frameworks/ruby/sinatra.html'>Sinatra</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>基础架构</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/infrastructure/overview.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/infrastructure/micro/mcf.html'>MCF</a>
<ul class='js-subguides'>
<li>
<a href='/infrastructure/micro/installing-mcf.html'>安装 MCF</a>
</li>
<li>
<a href='/infrastructure/micro/using-mcf.html'>使用 MCF</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>服务</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/services.html'>概述</a>
</li>
<li class='js-subtopic'>
<a href='/services/mongodb/mongodb.html'>MongoDB</a>
<ul class='js-subguides'>
<li>
<a href='/services/mongodb/grails-mongodb.html'>Grails</a>
</li>
<li>
<a href='/services/mongodb/nodejs-mongodb.html'>Node.js</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb.html'>Ruby</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb-gridfs.html'>GridFS</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/mysql/mysql-overview.html'>MySQL</a>
<ul class='js-subguides'>
<li>
<a href='/services/mysql/mysql.html'>介绍</a>
</li>
<li>
<a href='/services/mysql/grails-mysql.html'>Grails</a>
</li>
<li>
<a href='/services/mysql/ruby-mysql.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/rabbitmq/rabbitmq.html'>RabbitMQ</a>
<ul class='js-subguides'>
<li>
<a href='/services/rabbitmq/faq-rabbitmq.html'>常见问题</a>
</li>
<li>
<a href='/services/rabbitmq/nodejs-rabbitmq.html'>Node.js</a>
</li>
<li>
<a href='/services/rabbitmq/ruby-rabbitmq.html'>Ruby</a>
</li>
<li>
<a href='/services/rabbitmq/spring-rabbitmq.html'>Spring</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/redis/redis.html'>Redis</a>
<ul class='js-subguides'>
<li>
<a href='/services/redis/ruby-redis.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/postgres/postgres.html'>vFabric Postgres</a>
<ul class='js-subguides'>
<li>
<a href='/services/postgres/postgres-ruby.html'>Ruby</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>工具</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/tools/vmc/vmc.html'>VMC</a>
<ul class='js-subguides'>
<li>
<a href='/tools/vmc/installing-vmc.html'>安装</a>
</li>
<li>
<a href='/tools/vmc/debugging.html'>应用调试</a>
</li>
<li>
<a href='/tools/vmc/vmc-quick-ref.html'>快速参考</a>
</li>
<li>
<a href='/tools/vmc/vmc-non-interactive.html'>非交互模式</a>
</li>
<li>
<a href='/tools/vmc/caldecott.html'>Caldecott隧道</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/STS/sts-eclipse.html'>STS & Eclipse</a>
<ul class='js-subguides'>
<li>
<a href='/tools/STS/configuring-STS.html'>配置</a>
</li>
<li>
<a href='/tools/STS/debugging-CF-Eclipse.html'>应用调试</a>
</li>
<li>
<a href='/tools/STS/deploying-CF-Eclipse.html'>应用部署</a>
</li>
<li>
<a href='/tools/STS/remote-CF-Eclipse.html'>远程访问</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/spring-insight.html'>Spring Insight</a>
</li>
<li class='js-subtopic'>
<a href='/tools/gallery/box.html'>Box 集成</a>
</li>
<li class='js-subtopic'>
<a href='/tools/deploying-apps.html'>部署应用</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>部署云平台</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/deploy/overview.html'>概述</a>
</li>
<li class='js-subtopic'>
<a href='/deploy/dev_setup.html'>dev_setup</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/dev_setup-Single-Node.html'>单节点dev_setup</a>
</li>
<li>
<a href='/deploy/dev_setup-Multi-Node.html'>多节点dev_setup</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/bosh.html'>什么是BOSH</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/bosh-docs.html'>BOSH文档</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/vSphere.html'>在vSphere上部署</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/vSphere-IaaS.html'>准备IaaS环境</a>
</li>
<li>
<a href='/deploy/vSphere-BOSH.html'>安装BOSH</a>
</li>
<li>
<a href='/deploy/vSphere-CF.html'>部署Cloud Foundry</a>
</li>
<li>
<a href='/deploy/vSphere-CF-mgmt.html'>管理和运维Cloud Foundry</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/OpenStack.html'>在OpenStack上部署</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/os-install.html'>OpenStack Essex安装及配置</a>
</li>
<li>
<a href='/deploy/os-prepare.html'>准备BOSH CLI虚拟机</a>
</li>
<li>
<a href='/deploy/os-micro-bosh.html'>部署Micro BOSH</a>
</li>
<li>
<a href='/deploy/os-bosh.html'>部署BOSH</a>
</li>
<li>
<a href='/deploy/os-cf.html'>部署Cloud Foundry</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/customize.html'>定制Cloud Foundry</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/customize-framework.html'>添加框架</a>
</li>
<li>
<a href='/deploy/customize-runtime.html'>添加运行时</a>
</li>
<li>
<a href='/deploy/customize-services.html'>添加系统服务</a>
</li>
<li>
<a href='/deploy/customize-php.html'>支持PHP语言</a>
</li>
<li>
<a href='/deploy/customize-python.html'>支持Python语言</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>例子</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/samples/cool-apps.html'>酷炫应用程序</a>
</li>
<li class='js-subtopic'>
<a href='/samples/samples.html'>精彩代码分析</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<strong>
<a href='/faq.html'>FAQ</a>
</strong>
常见问题.
</p>
<p>
<strong>
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' target='_blank'>Forums</a>
</strong>
加入讨论.
</p>
<p>
<strong>
<a href='http://webinars.cloudfoundry.com'>Webinars</a>
</strong>
学习更多.
</p>
</div>
</div>
<div class='span-11 last'>
<h2>在vSphere上通过BOSH工具大规模部署Cloud Foundry</h2>
<p class='tags'>
<strong>Tags:</strong>
<span>
<a href="/tags/vSphere" rel="tag">vSphere</a><a href="/tags/BOSH" rel="tag">BOSH</a><a href="/tags/Deploy" rel="tag">Deploy</a><a href="/tags/IaaS" rel="tag">IaaS</a>
</span>
</p>
<p class='timestamp'>
<strong>Last Updated:</strong>
<span>
2013-01-11
</span>
</p>
<div id='social-share'></div>
<p>开始部署前，我们先讨论一下硬件和软件方面的前提条件。</p>

<h3 id="section">软件：</h3>

<p>1) 64 位 Ubuntu 10.04 LTS，最好是 ISO 格式。（注意：我们接下来的所有操作均只针对10.04）</p>

<p>2) vSphere V4.1 或 V5.x（本文采用vSphere 作为hypervisor）</p>

<p>3) vSphere Client</p>

<p>4) vCenter（安装在 Windows 2008 R2 64 位或 Windows 2003 服务器上，物理机或虚拟机皆可）</p>

<p>上述软件的60天或90天评估使用版本，均可以在对应公司的官方网站下载获得。</p>

<p>注意：本系列文章中提到的所有对部署和安装时间的估计如“几分钟”，“几十分钟”等均以上述硬件环境和网络环境为基础，实际情况应该略有不同。</p>

<h3 id="section-1">硬件：</h3>

<p>假设所有节点都是虚拟机，下表显示了所需的虚拟机数目：</p>

<table class="std">
<tr>
<th>组件</th>
      <th>节点数目</th>
      <th>操作系统</th>
      <th>可否是物理机</th>
    </tr>
<tr>
<td>BOSH CLI</td>
      <td>1</td>
      <td>Ubuntu</td>
      <td>可以</td>
    </tr>
<tr>
<td>vCenter+vSphere Client</td>
      <td>1</td>
      <td>Win2008</td>
      <td>可以安装在一起，也可划分成两个节点</td>
    </tr>
<tr>
<td>Micro BOSH</td>
      <td>1</td>
      <td>Ubuntu</td>
      <td>不可以</td>
    </tr>
<tr>
<td>BOSH</td>
      <td>6</td>
      <td>Ubuntu</td>
      <td>不可以</td>
    </tr>
<tr>
<td>Cloud Foundry</td>
      <td>34 *</td>
      <td>Ubuntu</td>
      <td>不可以，见下文</td>
    </tr>
<tr>
<td>合计：</td>
      <td>43</td>
      <td> </td>
      <td> </td>
    </tr>
</table><p>注意：上表中 Cloud Foundry 的节点数目是所需的最少节点数目。此数目可能会因实际的 Cloud Foundry 部署规模而异。选择硬件配置时通常要考虑两个原则：</p>

<pre><code>	1) vCPU总数不应超过物理核心总数的两倍。在生产系统中，两者之比应该接近于 1。
	2) 所有虚拟机的总内存应尽量小于或略微大于所有Hypervisor的物理内存。
</code></pre>

<p>下面例子是假设每个虚拟机有 4 GB 内存和 1 个vCPU时的硬件配置：</p>

<pre><code>	6 台服务器，每台服务器有 8 核 CPU和 32GB RAM。
</code></pre>

<p>就实验系统而言，我们曾在一台配置如下的服务器上成功部署（假定每个虚拟机有 256 MB 内存）：</p>

<pre><code>	1 台物理服务器：8 核 CPU，16 GB RAM。
</code></pre>

<p>对于生产环境，我们建议选择CPU核数和内存容量都比较大的机型，这样在同一台物理机，可以运行更多的虚拟机。同时需要考虑有比较高吞吐量的网卡和存储设备。</p>

<p>除了服务器之外，存储也是云平台中的一个关键要素。存储最好应有 200 GB 或更大的可用空间，以便保存所有虚拟机的映像。在生产系统中，建议采用快速的共享存储。NFS 是用来在Hypervisor间共享存储的最常用协议。在试验环境中，可以使用基于 Linux 的 NFS 服务器来代替专用存储。尽管Hypervisor中的本地磁盘在 测试环境中可以使用，但通常不建议将本地磁盘用于生产系统中。</p>

<p>我们最后应规划的是网络。在实验室环境中，我们可以直接将所有节点都放在同一网络中。不过，在生产系统中，出于安全和管理需要，应将 Cloud Foundry 的各个组件正确分配到VLAN中。在本文中，我们不讨论网络连接方面的细节。作为例子，我们在部署期间将采用四个VLAN：</p>

<table class="std">
<tr>
<th>VLAN</th>
      <th>节点</th>
    </tr>
<tr>
<td>Management VLAN</td>
      <td>Hypervisor和 NFS 存储</td>
    </tr>
<tr>
<td>CF VLAN</td>
      <td>BOSH 虚拟机以及 Cloud Foundry 的虚拟机</td>
    </tr>
<tr>
<td>Service VLAN</td>
      <td>LB ，双宿 (Dual-Homed) router</td>
    </tr>
<tr>
<td>Public VLAN</td>
      <td>LB，外网请求</td>
    </tr>
</table><p>Cloud Foundry 实例的安装过程分为以下四个部分：</p>

<p>1) 在 Ubuntu 10.04 操作系统中安装 BOSH CLI 工具。此操作系统的主机可以是物理机，也可以是虚拟机。</p>

<p>2) 安装Micro BOSH。Micro BOSH是一个包含 BOSH 所有组件的虚拟机。它所具备标准 BOSH 的所有功能。不过，它用来存储多个Release的磁盘空间十分有限。部署Micro BOSH的目的是为了安装 BOSH，因为BOSH 本身就是一个分布式系统。</p>

<p>3) 通过Micro BOSH来安装 BOSH。BOSH 通常包含 6 个结点，每个节点部署一个组件。其中一个称作blobstore的节点具有较大的磁盘，可以保存较大的Release。</p>

<p>4) 通过 BOSH 安装 Cloud Foundry 实例。</p>

<h3 id="section-2">重要前提条件：</h3>

<p>在 BOSH 和 Cloud Foundry 的整个安装过程中，都需要直接的 Internet 连接。这一点非常重要，因为部分软件代码是直接从 Internet 下载的，例如 Ruby Gem 以及一些开源软件。在虚拟机与 Internet 之间设置 Web 代理服务器将导致安装失败。注：NAT是允许的。</p>

<p>另一项前提条件是要有稳定的 Internet 连接。如果您的网络在从 Internet 下载文件时速度缓慢或者不可靠，安装可能会因出现超时或连接错误而失败。</p>

<p>我们遇到过很多因为 Internet 连接问题而安装失败的情况。强烈建议您先咨询网络管理员，再开始安装 BOSH。</p>

<h3 id="vcenter-">在 vCenter 中创建一个群集</h3>

<p>假定所有节点都是虚拟机，那么我们首先在所有裸机服务器上安装 vSphere（在本篇文章中我们采用 V5.x）。各 vSphere 服务器通过Management VLAN相连。安装完毕后，我们需在其中一个Hypervisor上创建一个虚拟机以安装 64 位 Windows 2008 R2。随后，我们需在此 Windows 2008 虚拟机上安装 vCenter。下一步是使用 vSphere Client 连接到 vCenter，以便我们可以管理这些服务器。</p>

<p>有关vSphere，vCenter和vSphere Client的安装使用细节，请参考VMware官方网站中的文档介绍 <a href="http://www.vmware.com/cn/products/">http://www.vmware.com/cn/products/</a></p>

<p>我们可以在任意 Windows机器（甚至是虚拟机）上安装 vSphere Client。之后，我们便可以通过 vSphere Client 以远程方式连接到 vCenter。首先，我们来在 vCenter 中创建一个数据中心。为此，请右键单击左窗格中的 vCenter 节点，然后选择“新建数据中心”（New Datacenter）以添加一个新的数据中心。</p>

<p><img src="/images/deploy/fig5.png" alt="fig5.png"></p>

<p>接下来，请右键单击新创建的数据中心节点，然后选择“新建群集…”(New Cluster…)。</p>

<p><img src="/images/deploy/fig6.png" alt="fig6.png"></p>

<p>在“新建群集向导”(New Cluster Wizard) 执行期间，如果您启用了 vSphere DRS 功能，系统将要求您配置 VMware DRS。请确保“自动化级别”(Automation Level) 设置为“半自动”(Partially Automated) 或“全自动”(Fully Automated)，如下所示。如果您选择“手动”(Manual)，将会弹出一个窗口提示您输入您的选择。这种行为可能会阻止 BOSH 自动化安装。</p>

<p><img src="/images/deploy/fig7.png" alt="fig7.png"></p>

<p>然后，请选中“启用主机监控”(Enable Host Monitoring) 复选框，再选中“禁用:启动违反可用性限制的虚拟机”(Disable: Power on VMs that violate availability constraints)：</p>

<p><img src="/images/deploy/fig8.png" alt="fig8.png"></p>

<p>接着，转到“虚拟机监控”(VM Monitoring) 子部分，选择“已禁用”(Disabled)：</p>

<p><img src="/images/deploy/fig9.png" alt="fig9.png"></p>

<p>单击“下一步”(Next)，按如下所示做出选择：</p>

<p><img src="/images/deploy/fig10.png" alt="fig10.png"></p>

<h3 id="vsphere-">添加 vSphere 主机</h3>

<p>下一步是将hypervisor放入我们刚创建的群集中。为此，请右键单击该群集节点，然后选择“添加主机…”(Add Host…)。对于每台 vSphere 服务器，输入其 IP 地址、管理员用户名和密码，然后确认您进行的配置：</p>

<p><img src="/images/deploy/fig11.png" alt="fig11.png"></p>

<p>添加完所有主机后，这些主机将在“数据中心”(Datacenter) -&gt;“主机”(Hosts) 选项卡中列出：</p>

<p><img src="/images/deploy/fig12.png" alt="fig12.png"></p>

<h3 id="section-3">将数据存储挂接到主机</h3>

<p>该群集中的所有主机都应共享同一 NFS 存储。对于每个主机，我们将该存储以数据存储的形式添加进来。为此，请在 vCenter 中单击相应的 vSphere 主机，然后选择“配置”(Configuration) 选项卡。选择“硬件”(Hardware) -&gt;“存储”(Storage)。单击右上方的“Add Storage…”(添加存储…) </p>

<p><img src="/images/deploy/fig13.png" alt="fig13.png"></p>

<p>在“选择存储类型”(Select Storage Type) 对话框中，选择“网络文件系统”(Network File System)。</p>

<p><img src="/images/deploy/fig14.png" alt="fig14.png"></p>

<p>输入 NFS 存储的 IP 地址、相应的文件夹名称以及相应的数据存储名称。请务必对该群集内的所有主机都采用完全相同的数据存储名称，这一点非常重要。在本例中，我们采用“NFSdatastore”这一名称。</p>

<p><img src="/images/deploy/fig15.png" alt="fig15.png"></p>

<h3 id="section-4">为虚拟机和模板创建文件夹</h3>

<p>从 vCenter 的导航栏中，选择“主页”(Home) -&gt;“清单”(Inventory) -&gt;“虚拟机和模板”(VMs and Templates) 视图，然后按如下所示创建文件夹：</p>

<p><img src="/images/deploy/fig16.png" alt="fig16.png"></p>

<p>这些文件夹随后将用来对 BOSH 和 Cloud Foundry 的虚拟机进行分组。在上例中，“template_folder_bosh”用来存放 BOSH stemcell。“vm_folder_bosh”用来存放 BOSH 节点。“template_folder”用来存放 Cloud Foundry stemcell。“vm_folder”用来存放 Cloud Foundry 节点。随后将在部署清单文件中用到这些名称。</p>

<h3 id="section-5">网络配置</h3>

<p>Cloud Foundry 的虚拟机将部署到一个或多个网络中。在部署前，我们需要在 vSphere 中创建一些网络。下图显示了 Cloud Foundry 所需的网络连接。</p>

<p><img src="/images/deploy/fig17.png" alt="fig17.png"></p>

<p>在每个 vSphere 主机上，我们创建以下两个网络：</p>

<pre><code>	1)	CF Network：映射到 CF VLAN
	2)	Service Network：映射到Service VLAN。
</code></pre>

<p>大多数虚拟机都位于 CF Network上。只有router虚拟机是双宿在Service Network和 CF Network上。</p>

<p>注意：在试验环境中，您可以将所有虚拟机都放在同一网络上，以便简化安装过程。因此，Hypervisor上的只有1个网络可能就绰绰有余。</p>

<p>要创建网络，请选择“主机和群集”(Hosts and Clusters) 视图。选择一个主机，然后切换到“配置”(Configuration) 选项卡。然后选择“网络”(Networking)，再单击“添加网络”(Add Networking)：</p>

<p><img src="/images/deploy/fig18.png" alt="fig18.png"></p>

<p>连接类型应为“虚拟机”(Virtual Machine)：</p>

<p><img src="/images/deploy/fig19.png" alt="fig19.png"></p>

<p>请使用现有的虚拟交换机：</p>

<p><img src="/images/deploy/fig20.png" alt="fig20.png"></p>

<p>在下一步中，将网络标签重命名为“CF Network”。如果网络管理员已经指定了VLAN ID，请相应地输入 CF VLAN ID。</p>

<p><img src="/images/deploy/fig21.png" alt="fig21.png"></p>

<p>然后单击“完成”(Finish)，这样便完成了网络创建。重复上述步骤创建“Service Network”，直接将网络标签命名为“Service Network”即可。
务必要让同一群集内所有主机上的网络名称都保持完全相同。下图显示已经为某个主机创建了两个网络。我们将这两个网络分别命名为“CF Network”和“Service Network”。稍后在 BOSH 和 Cloud Foundry 的 yml 文件中将会用到这两个名称。</p>

<p><img src="/images/deploy/fig22.png" alt="fig22.png"></p>

<p>此外，如果您从“数据中心”(Datacenter) -&gt;“清单”(Inventory) -&gt;“网络”(Networking) 视图中进行查看的话，显示如下：</p>

<p><img src="/images/deploy/fig23.png" alt="fig23.png"></p>

<h3 id="bosh-cli-">为 BOSH CLI 创建一个虚拟机</h3>

<p>从 vCenter 中，我们选择该群集中的主机之一来创建一个虚拟机。为此，请单击“创建新虚拟机”(Create a new virtual machine)。我们将在此虚拟机上安装 64 位 Ubuntu 10.04 操作系统。为此虚拟机分配 2 个虚拟 CPU、2 GB 内存、20 GB 磁盘空间（或者更多）。在安装期间，一定要手动设置网络。</p>

<p><img src="/images/deploy/fig24.png" alt="fig24.png"></p>

<p>我们现在开始在该虚拟机上安装 BOSH CLI。为此，请登录到 Ubuntu，然后遵照以下步骤操作。（请注意，这些步骤大都摘自 BOSH 官方文档。为了您方便起见，在此将它们列出来。）</p>

<p>在安装前更新一下Ubuntu的apt-get：</p>

<p><code>$ sudo apt-get upgrade (takes long time, 200M+ files to download, optional for bosh install)</code>
<code>$ sudo apt-get dist-upgrade (200M+ to download, update the kernel and image, optional)</code>
<code>$ sudo reboot</code></p>

<p>安装BOSH CLI需要完整的Ruby环境，所以接下来我们分别介绍如何使用rbenv和rvm这两种Ruby版本管理器来安装Ruby和BOSH CLI。其中使用rvm安装的方法相对简单且易于维护，建议大家使用。</p>

<h4 id="rbenvrubybosh-cli">方法一：通过rbenv安装Ruby和bosh cli</h4>

<p>1.安装 Ruby 的依赖项：</p>

<p><code>$ sudo apt-get install git-core build-essential libsqlite3-dev</code> 
<code>\curl libmysqlclient-dev libxml2-dev libxslt-dev libpq-dev genisoimage</code></p>

<p>2.获取最新版本的rbenv</p>

<p><code>$ git clone git://github.com/sstephenson/rbenv.git .rbenv</code></p>

<p>3.将 ~/.rbenv/bin 添加到您的 $PATH 以便能够访问rbenv命令行实用程序 </p>

<p><code>$ echo 'export PATH="$HOME/.rbenv/bin:$PATH"' &gt;&gt; ~/.bash_profile</code></p>

<p>4.将rbenvinit添加到您的 shell 以启用填充程序 (Shim) 和自动完成</p>

<p><code>$ echo 'eval "$(rbenv init -)"' &gt;&gt; ~/.bash_profile</code></p>

<p>5.下载 Ruby 1.9.2
注意：您也可以使用适用于 rbenv 的 ruby-build 插件来构建 ruby。请参见https://github.com/sstephenson/ruby-build</p>

<p><code>$ wget http://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.2-p290.tar.gz</code></p>

<p>6.将 Ruby 解包并安装</p>

<pre><code>$ tar xvfz ruby-1.9.2-p290.tar.gz
$ cd ruby-1.9.2-p290
$ ./configure --prefix=$HOME/.rbenv/versions/1.9.2-p290
$ make
$ make install
</code></pre>

<p>7.重新启动您的 shell 以使路径更改生效
<code>$ source ~/.bash_profile</code></p>

<p>8.将您的默认 Ruby 设置为 1.9.2 版本
<code>$ rbenv global 1.9.2-p290</code></p>

<p>注意：使用此方法时可能需要重新安装 rake 0.8.7 gem
<code>$ gem pristine rake</code></p>

<p>9.更新rubygem并安装捆绑包。
注意：安装 gem（gem install 或 bundle install）后，请运行rbenv rehash 以添加新的填充程序</p>

<pre><code>$ rbenv rehash
$ gem update –system
$ gem install bundler
$ rbenv rehash
</code></pre>

<p>最后，安装 BOSH CLI：</p>

<p>1.安装 gerrit-cli gem：
<code>$ gem install gerrit-cli</code></p>

<p>2.安装 BOSH CLI：</p>

<pre><code>$ gem install bosh_cli
$ rbenv rehash
$ bosh –version
</code></pre>

<p>如果一切运行顺利，最后一个命令将会显示您刚刚创建的 BOSH 版本。这表明 BOSH CLI 已安装成功。</p>

<h4 id="rvmrubybosh-cli">方法二：使用rvm安装Ruby和bosh cli：</h4>

<p><code>$ sudo apt-get install curl</code></p>

<p><code>\curl -L https://get.rvm.io | bash -s</code></p>

<p>在.bashrc中添加rvm的环境变量，否则退出终端后再进入，rvm不会被正常加载：</p>

<p><code>[[ -s "$HOME/.rvm/scripts/rvm" ]] &amp;&amp; source "$HOME/.rvm/scripts/rvm"</code></p>

<p><code>$ source .bashrc</code></p>

<p><code>$ source ~/.bash-profile</code></p>

<p>输入下面指令来验证rvm是否安装成功：</p>

<p><code>$ type rvm |head -1</code></p>

<p>正确的返回结果：</p>

<p><code>rvm is a function</code></p>

<p>然后重启终端rvm就可以工作了。</p>

<p>执行<code>$ rvm requirements</code></p>

<p>rvm的依赖包可以用过这条命令列出，经过测试，只要把这些依赖装好，之后的cli和bosh deploy gem的依赖，都已经自动加入了</p>

<p>执行<code>rvm install 1.9.2</code> 这个ruby的安装非常耗费时间，一般在半个小时左右</p>

<p>执行<code>ruby -v</code> 检测ruby版本</p>

<p>安装一些bosh cli所需的gem包：</p>

<pre><code>$ gem install bundler
$ gem install rake
$ gem install gerrit-cli
$ gem install bosh_cli
</code></pre>

<p>执行<code>$ bosh --version</code>看到版本号，说明bosh cli安装成功。</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='footer'>
<div class='site-wrap'>
<div class='row'>
<div class='span-3 social-icons'>
<a class='twitter replaced' href='http://e.weibo.com/2169336083/profile' rel='external' target='_blank'>Weibo</a>
<a class='facebook replaced' href='http://cloudfoundry.csdn.net' rel='external' target='_blank'>CSDN</a>
<a class='youtube replaced' href='http://i.youku.com/u/id_UNDI5MTA2Mjk2' rel='external' target='_blank'>YouKu</a>
</div>
<div class='prepend-2 span-5'>
<p>
<!-- %a{:href => "#{url(@config, :www_app)}/faq"} 问题 -->
<a href='http://cndocs.cloudfoundry.com/faq.html'>问题</a>
|
<a href='http://forum.csdn.net/slist/cloudfoundry' rel='external'>论坛</a>
|
<!-- %a{:href => url(@config, :blog_app), :rel => "external"} 博客 -->
<a href='http://cnblog.cloudfoundry.com/' rel='external'>博客</a>
|
<a href='http://www.cloudfoundry.com/jobs'>工作</a>
|
<a href='http://www.cloudfoundry.com/legal'>法律</a>
|
<a href='http://www.cloudfoundry.com/terms'>条款</a>
|
<a href='http://www.vmware.com/help/privacy.html' rel='external' target='_blank'>隐私</a>
</p>
</div>
<div class='span-5 last right'>
<p>Copyright &copy; 2013 VMware, Inc. All rights reserved.</p>
</div>
</div>
</div>
</div>
<script>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-22181585-14']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    /$(document).ready(function() {
     / $('#social-share').dcSocialShare({
      /  buttonSize: 'horizontal',
      / buttons: 'facebook,twitter,plusone,linkedin',
      /  location: 'top',
      /  align: 'right',
      /  offsetLocation: 260,
      /  offsetAlign: 100,
      /  width: 80,
      /  center: true,
      /  centerPx: 600,
      /  disableFloat: true,
      /  tabText: '',
      /  twitterId: 'cloudfoundry'
      /});
    /});
  //]]>
</script>
</body>
</html>
