<!DOCTYPE html>
<!--[if IE]>  <![endif]-->
<!--[if lt IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie6"> <![endif]-->
<!--[if IE 7 ]> <html lang="en" dir="ltr" class="no-js old_ie ie7"> <![endif]-->
<!--[if IE 8 ]> <html lang="en" dir="ltr" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]> <html lang="en" dir="ltr" class="no-js ie9"> <![endif]-->
<html lang='en' xmlns:og='http://ogp.me/ns#'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='VMware' name='author'>
<meta content='Copyright VMware 2011. All Rights Reserved.' name='copyright'>
<meta content='juhk3p2B-UhzEjLXtqFwDMVLo5Lmy4ZP-zVe7Gxo2Dw' name='google-site-verification'>
<meta content='en-us' http-equiv='Content-Language'>
<meta content='false' http-equiv='imagetoolbar'>
<meta content='true' name='MSSmartTagsPreventParsing'>
<meta content='all' name='robots'>
<meta content='147862838623179' property='fb:app_id'>
<meta content='website' property='og:type'>
<meta content='https://docs.cloudfoundry.com/deploy/vSphere-CF-mgmt.html' property='og:url'>
<meta content='https://docs.cloudfoundry.com/images/cf100.png' property='og:image'>
<meta content='Cloud Foundry | 扩展内容' property='og:title'>
<meta content='在vSphere上通过BOSH工具大规模部署Cloud Foundry' property='og:description'>
<meta content='en_US' property='og:locale'>
<title>Cloud Foundry | 扩展内容</title>
<link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css'>
<link href='/stylesheets/master.css' media='screen' rel='stylesheet' type='text/css'>
<link href='favicon.ico' rel='shortcut icon'>
<link href='/stylesheets/uv_active4d.css' rel='stylesheet' type='text/css'>
<link href='/stylesheets/documentation.css' media='screen' rel='stylesheet' type='text/css'>
<link href='/stylesheets/pygments.css' media='screen' rel='stylesheet' type='text/css'>
<script src='/js/jquery-1.6.4.min.js' type='text/javascript'></script>
<script src='/js/documentation.js' type='text/javascript'></script>
<script src='/js/jquery.easing.js' type='text/javascript'></script>
<script src='/js/jquery.social.share.1.2.min.js' type='text/javascript'></script>
<!--[if lt IE 9 ]> <link href="/stylesheets/ie.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<!--[if lt IE 8 ]> <link href="/stylesheets/ie7.css" media="screen" rel="stylesheet" type="text/css" /> <![endif]-->
<link href='/stylesheets/master-cf.css' media='screen' rel='stylesheet' type='text/css'>
</head>
<body class='api'>
<div class='wrapper'>
<div class='container' id='header'>
<div class='site-wrap'>
<div class='container'>
<div class='span-6 logo-wrap'>
<!-- %a{:href => url(@config, :www_app)} -->
<a href='http://www.cloudfoundry.cn'>
<img alt="Cloud Foundry: The Industry's First Open Platform As A Service" height='70' src='/images/logo_header_cloudfoundry.png' width='373'>
<span class='replaced'>Cloud Foundry: The Industry's First Open Platform As A Service</span>
</img>
</a>
</div>
<div class='span-9 last'>
<div class='right'>
<form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input' name='q' placeholder='search' type='text' value=''>
</form>
<ul class='super-nav'>
<li>
<a href='http://my.cloudfoundry.com/signup'>注册</a>
</li>
<li>
<a href='http://my.cloudfoundry.com/micro'>下载</a>
</li>
<li>
<a href='http://support.cloudfoundry.com' rel='external' target='_blank'>支持</a>
</li>
<li>
<a href='http://status.cloudfoundry.com' target='_blank'>状态</a>
</li>
<li>
<a href='http://http://www.cloudfoundry.com' target='_blank'>英文站点</a>
</li>
</ul>
</div>
<div id='nav'>
<ul>
<li class='selected'>
<a href='http://cndocs.cloudfoundry.com'>技术文档</a>
</li>
<li>
<!-- %a{:href => "#{url(@config, :www_app)}/getinvolved"} 如何参与 -->
<a href='http://cn.cloudfoundry.com/getinvolved'>如何参与</a>
</li>
<li>
<!-- %a{:href => "#{url(@config, :www_app)}/partners"} 合作伙伴 -->
<a href='http://cn.cloudfoundry.com/partners'>合作伙伴</a>
</li>
<li>
<!-- %a{:href => url(@config, :blog_app)} 中文博客 -->
<a href='http://cnblog.cloudfoundry.com/'>中文博客</a>
</li>
<li>
<!-- %a{:href => "#{url(@config, :www_app)}/about"} 关于我们 -->
<a href='http://cn.cloudfoundry.com/about'>关于我们</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='main'>
<div class='content-wrap'>
<div class='header-wrap clearfix'>
<div class='site-wrap'>
<h1>Deploy</h1>
<p class='sub-head'>扩展内容</p>
</div>
</div>
<div class='site-wrap'>
<div class='container content'>
<div class='span-15 prepend-top'>
<div class='span-4'>
<div class='sub-nav'>
<p>
<strong>
<a href='/getting-started.html'>Cloud Foundry入门</a>
</strong>
迅速开始使用Cloud Foundry的入门文档.
</p>
<form action='http://www.cloudfoundry.com/search' class='search-form-docs' method='get' onsubmit='return submitQuery()'>
<input autocomplete='off' class='search-input-docs' name='q' placeholder='search docs' type='text' value='more:docs'>
</form>
<br>
<br>
<div class='sidebar-shell' id='js-sidebar'>
<div class='js-accordion-list sidebar-module'>
<ul>
<li class='js-topic'>
<h3>
<a href='#'>语言和编程框架</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/frameworks.html'>概述</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/spring.html'>Spring</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/java/spring/spring-insight.html'>Spring Insight</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/java/spring/grails.html'>Grails</a>
</li>
<li class='js-subtopic'>
<a href='/frameworks/scala/scala.html'>Scala</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/scala/lift.html'>Lift</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/play/play.html'>Play</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/play/java-getting-started.html'>Java入门指南</a>
</li>
<li>
<a href='/frameworks/play/scala-getting-started.html'>Scala入门指南</a>
</li>
<li>
<a href='/frameworks/play/java-mysql.html'>在Java应用中使用MySQL</a>
</li>
<li>
<a href='/frameworks/play/java-postgresql.html'>在Java应用中使用PostgreSQL</a>
</li>
<li>
<a href='/frameworks/play/java-mongodb.html'>在Java应用中使用MongoDB</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/nodejs/nodejs.html'>Node.js</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/nodejs/nodeAutoReconfig.html'>有关自动配置</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/frameworks/ruby/ruby-rails-sinatra.html'>Ruby, Rails, Sinatra</a>
<ul class='js-subguides'>
<li>
<a href='/frameworks/ruby/ruby.html'>概述</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-cf.html'>相关事宜</a>
</li>
<li>
<a href='/frameworks/ruby/installing-ruby.html'>安装 Ruby</a>
</li>
<li>
<a href='/frameworks/ruby/ruby-simple.html'>创建应用</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-0.html'>Rails 3.0</a>
</li>
<li>
<a href='/frameworks/ruby/rails-3-1.html'>Rails 3.1</a>
</li>
<li>
<a href='/frameworks/ruby/sinatra.html'>Sinatra</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>基础架构</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/infrastructure/overview.html'>Overview</a>
</li>
<li class='js-subtopic'>
<a href='/infrastructure/micro/mcf.html'>MCF</a>
<ul class='js-subguides'>
<li>
<a href='/infrastructure/micro/installing-mcf.html'>安装 MCF</a>
</li>
<li>
<a href='/infrastructure/micro/using-mcf.html'>使用 MCF</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>服务</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/services.html'>概述</a>
</li>
<li class='js-subtopic'>
<a href='/services/mongodb/mongodb.html'>MongoDB</a>
<ul class='js-subguides'>
<li>
<a href='/services/mongodb/grails-mongodb.html'>Grails</a>
</li>
<li>
<a href='/services/mongodb/nodejs-mongodb.html'>Node.js</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb.html'>Ruby</a>
</li>
<li>
<a href='/services/mongodb/ruby-mongodb-gridfs.html'>GridFS</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/mysql/mysql-overview.html'>MySQL</a>
<ul class='js-subguides'>
<li>
<a href='/services/mysql/mysql.html'>介绍</a>
</li>
<li>
<a href='/services/mysql/grails-mysql.html'>Grails</a>
</li>
<li>
<a href='/services/mysql/ruby-mysql.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/rabbitmq/rabbitmq.html'>RabbitMQ</a>
<ul class='js-subguides'>
<li>
<a href='/services/rabbitmq/faq-rabbitmq.html'>常见问题</a>
</li>
<li>
<a href='/services/rabbitmq/nodejs-rabbitmq.html'>Node.js</a>
</li>
<li>
<a href='/services/rabbitmq/ruby-rabbitmq.html'>Ruby</a>
</li>
<li>
<a href='/services/rabbitmq/spring-rabbitmq.html'>Spring</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/redis/redis.html'>Redis</a>
<ul class='js-subguides'>
<li>
<a href='/services/redis/ruby-redis.html'>Ruby</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/services/postgres/postgres.html'>vFabric Postgres</a>
<ul class='js-subguides'>
<li>
<a href='/services/postgres/postgres-ruby.html'>Ruby</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>工具</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/tools/vmc/vmc.html'>VMC</a>
<ul class='js-subguides'>
<li>
<a href='/tools/vmc/installing-vmc.html'>安装</a>
</li>
<li>
<a href='/tools/vmc/debugging.html'>应用调试</a>
</li>
<li>
<a href='/tools/vmc/vmc-quick-ref.html'>快速参考</a>
</li>
<li>
<a href='/tools/vmc/vmc-non-interactive.html'>非交互模式</a>
</li>
<li>
<a href='/tools/vmc/caldecott.html'>Caldecott隧道</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/STS/sts-eclipse.html'>STS & Eclipse</a>
<ul class='js-subguides'>
<li>
<a href='/tools/STS/configuring-STS.html'>配置</a>
</li>
<li>
<a href='/tools/STS/debugging-CF-Eclipse.html'>应用调试</a>
</li>
<li>
<a href='/tools/STS/deploying-CF-Eclipse.html'>应用部署</a>
</li>
<li>
<a href='/tools/STS/remote-CF-Eclipse.html'>远程访问</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/tools/spring-insight.html'>Spring Insight</a>
</li>
<li class='js-subtopic'>
<a href='/tools/gallery/box.html'>Box 集成</a>
</li>
<li class='js-subtopic'>
<a href='/tools/deploying-apps.html'>部署应用</a>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>部署云平台</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/deploy/overview.html'>概述</a>
</li>
<li class='js-subtopic'>
<a href='/deploy/dev_setup.html'>dev_setup</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/dev_setup-Single-Node.html'>单节点dev_setup</a>
</li>
<li>
<a href='/deploy/dev_setup-Multi-Node.html'>多节点dev_setup</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/bosh.html'>什么是BOSH</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/bosh-docs.html'>BOSH文档</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/vSphere.html'>在vSphere上部署</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/vSphere-IaaS.html'>准备IaaS环境</a>
</li>
<li>
<a href='/deploy/vSphere-BOSH.html'>安装BOSH</a>
</li>
<li>
<a href='/deploy/vSphere-CF.html'>部署Cloud Foundry</a>
</li>
<li>
<a href='/deploy/vSphere-CF-mgmt.html'>管理和运维Cloud Foundry</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/OpenStack.html'>在OpenStack上部署</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/os-install.html'>OpenStack Essex安装及配置</a>
</li>
<li>
<a href='/deploy/os-prepare.html'>准备BOSH CLI虚拟机</a>
</li>
<li>
<a href='/deploy/os-micro-bosh.html'>部署Micro BOSH</a>
</li>
<li>
<a href='/deploy/os-bosh.html'>部署BOSH</a>
</li>
<li>
<a href='/deploy/os-cf.html'>部署Cloud Foundry</a>
</li>
</ul>
</li>
<li class='js-subtopic'>
<a href='/deploy/customize.html'>定制Cloud Foundry</a>
<ul class='js-subguides'>
<li>
<a href='/deploy/customize-framework.html'>添加框架</a>
</li>
<li>
<a href='/deploy/customize-runtime.html'>添加运行时</a>
</li>
<li>
<a href='/deploy/customize-services.html'>添加系统服务</a>
</li>
<li>
<a href='/deploy/customize-php.html'>支持PHP语言</a>
</li>
<li>
<a href='/deploy/customize-python.html'>支持Python语言</a>
</li>
</ul>
</li>
</ul>
</li>
<li class='js-topic'>
<h3>
<a href='#'>例子</a>
</h3>
<ul class='js-guides'>
<li class='js-subtopic'>
<a href='/samples/cool-apps.html'>酷炫应用程序</a>
</li>
<li class='js-subtopic'>
<a href='/samples/samples.html'>精彩代码分析</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<strong>
<a href='/faq.html'>FAQ</a>
</strong>
常见问题.
</p>
<p>
<strong>
<a href='http://stackoverflow.com/questions/tagged/cloudfoundry' target='_blank'>Forums</a>
</strong>
加入讨论.
</p>
<p>
<strong>
<a href='http://webinars.cloudfoundry.com'>Webinars</a>
</strong>
学习更多.
</p>
</div>
</div>
<div class='span-11 last'>
<h2>在vSphere上通过BOSH工具大规模部署Cloud Foundry</h2>
<p class='tags'>
<strong>Tags:</strong>
<span>
<a href="/tags/vSphere" rel="tag">vSphere</a><a href="/tags/BOSH" rel="tag">BOSH</a><a href="/tags/Deploy" rel="tag">Deploy</a><a href="/tags/IaaS" rel="tag">IaaS</a>
</span>
</p>
<p class='timestamp'>
<strong>Last Updated:</strong>
<span>
2013-01-29
</span>
</p>
<div id='social-share'></div>
<p>在上一篇文章里我们已经完成了Cloud Foundry的安装过程，这一部分我们将在前面工作的基础上进行一些扩展功能的使用。</p>

<p><strong>如何使用Dashboard来对Cloud Foundry 进行监控</strong></p>

<p>在Cloud Foundry的组件里面，有一个叫dashboard的job，它可以让管理员监控Cloud Foundry的运行状态，这是日常运维中不可或缺的工具。在Dashboard中使用了OpenTSDB作为其数据存储。在我们部署Cloud Foundry的yml中已经给出了Dashboard这个job的配置方法。Dashboard需要使用OpenTSDB和collector， 而OpenTSDB的正常运行则依赖于HBase Master和HBase Slave。因此，如果我们想要使用Dashboard，首先需要确认这些有关的job都在Cloud Foundry的yml文件中正确地配置并部署了。 这里需要注意的是这些job是存在依赖关系的，所以要保证他们在yml里的描述定义按照如下顺序 ：hbase_slave，hbase_master，opentsdb，collector，dashboard。
由于Dashboard的用户认证采用了UAA模块，因此我们在使用之前还要配置管理员用户和赋予其使用Dashboard的管理权限。配置的过程如下：</p>

<p>首先我们安装一个叫做uaac的命令行工具，登录到BOSH CLI这台虚拟机上安装必要的依赖：</p>

<pre><code>for GEM in bundler rake rspec simplecov simplecov-rcov ci_reporter highline rest-client yajl-ruby eventmachine launchy em-http-request ; do
    gem install $GEM
done
</code></pre>

<p>下载uaa的源码并使用源码安装uaac：</p>

<pre><code>gerrit clone ssh://&lt;username&gt;@reviews.cloudfoundry.org:29418/uaa
cd uaa/gem
bundle install
gem build cf-uaa-client.gemspec
gem install cf-uaa-client-&lt;gem version&gt;.gem 
uaac -v
</code></pre>

<p>uaac 安装成功以后我们需要使用他来完成添加用户的操作：</p>

<pre><code>$ uaac target http://uaa.&lt;YOURtarget&gt;.com
$ uaac token client get dashboard --secret &lt;copy-paste the secret from UAA clients&gt;
$ uaac member add dashboard.user &lt;username1&gt; &lt;username2&gt; ... &lt;usernameN&gt;
# For eg. - $ uaac member add dashboard.user admin@vmware.com
$ uaac token delete
</code></pre>

<p>如果在上面的操作中有错误提示group不存在，可参照uaac帮助信息来执行uaac group add [name]就可以了。命令中的secret就是在Cloud Foundry的yml文件中定义的属性值uaa.clients.dashboard.secret，dashboard.user是赋予用户使用dashboard的权限，username1等用户名就是我们配置过的Cloud Foundry管理员用户邮箱（比如：admin@vmware.com）。
配置完成后，我们就可以登录Dashboard了。登录过程会跳转到UAA的页面，登录成功后就可以看到Dashboard的页面了。如果这一步登录后只显示登录成功没有跳转到Dashboard，手动访问一下Dashboard的URL(dashboard.yourdomain.com)即可。</p>

<p><img src="/images/deploy/fig29.png" alt="fig29.png"></p>

<p>我们可以看到在这个页面上有多个标签页，每一个标签页代表了一种我们的监控项。现在我们切换到System标签页，有可能发现这一页上是没有数据的。System标签页负责监控当前环境中所有Cloud Foundry虚拟机的资源状况，这些数据的来源需要BOSH的HealthMonitor组件和Cloud Foundry的OpenTSDB一起来负责。所以查看我们的BOSH部署文件bosh.yml中HealthMonitor的properties部分，我们会看到tsdb部分被注释掉了：</p>

<pre><code>hm:
    ...
    smtp:
      ...
    # tsdb_enabled: true
    # tsdb:
      # address: 10.40.97.85
      # port: 4242
</code></pre>

<p>之所以注释掉的原因是这里HM依赖的OpenTSDB是Cloud Foundry的一个job，也就是说我们在部署BOSH的时候OpenTSDB还没有安装，所以需要暂时注释掉了这个部分。 当我们按照文章第三部分部署过Cloud Foundry之后，OpenTSDB就存在了，所以我们只需要把这部分注释去掉（注意tsdb要和上面的smtp处于同一级别），然后重新deploy一次BOSH就可以了。由于BOSH的部署是增量式的，所以这次更新BOSH的操作只需要很短的时间就能完成。</p>

<pre><code>$ bosh target http://&lt;ip_of_micro_bosh&gt;:25555
$ bosh deployment bosh.yml
$ bosh deploy
</code></pre>

<p>部署完成后，直接访问Dashboard并查看System标签页，我们就能看到System的数据了。</p>

<p><strong>如何使用BOSH扩展Cloud Foundry</strong></p>

<p>在BOSH的帮助下我们如果想要对Cloud Foundry进行水平扩展的话是一件非常容易的事情。</p>

<p>以DEA为例子，打开我们用来部署Cloud Foundry的cf.yml文件，找到其中定义DEA job的部分：</p>

<pre><code>- name: dea
  template: dea
  instances: 2
  resource_pool: medium
  networks:
  - name: default
    static_ips:
    - 10.40.97.65
    - 10.40.97.66
</code></pre>

<p>我们只需要把这里的instance变成3，然后在static_ips部分分配一个新的IP就可以了：</p>

<pre><code>- name: dea
  template: dea
  instances: 3
  resource_pool: medium
  networks:
  - name: default
    static_ips:
    - 10.40.97.65
    - 10.40.97.66
    - 10.40.97.110
</code></pre>

<p>由于我们新添加了一个DEA，所有首先我们需要保证我们新添加的IP是有效的，也就是在我们cf.yml里面指定的network.static范围内，否则的话就需要调整这部分IP的范围。 另外，新添加的DEA还会多使用一个medium大小的资源，所以我们还需要把cf.yml文件中reousrce_pools部分对应的medium资源的size由4增加1到5：</p>

<pre><code>- name: medium
  network: default
  size: 5
  stemcell:
    name: bosh-stemcell
    version: 0.6.4
  cloud_properties:
    ram: 2048
    disk: 16384
    cpu: 2
</code></pre>

<p>然后重新执行bosh deploy即可，BOSH会提示你当前部署文件发生的改动如下图所示，请一定要认真确认过之后再执行部署:
<img src="/images/deploy/fig30.png" alt="fig30.png"></p>

<p>如果一切正常，执行bosh vms命令就可以查看到新添的DEA实例，其index为2。</p>

<p><strong>如何使用BOSH更新Cloud Foundry的代码</strong></p>

<p>BOSH可以在线升级Cloud Foundry的系统，即新版本的代码可以平滑地切换到生产系统中，整个升级过程不影响生产系统的运行。我们以升级Cloud Controller为例子，对这个过程做个介绍。
假定Cloud Foundry里面有若干个Cloud Controller的实例，我们要把它们从版本V1升级到V2。BOSH在升级的时候首先部署一个V2版本的Cloud Controller实例，称为金丝雀实例(Canary)。它的作用是验证新版本V2是否可部署成功并运行。如果该实例不能正常运行，则整个升级过程报错并停止。如果金丝雀实例部署成功，则在系统里面部署更多的V2实例，同时删除旧的V1实例，直到整个过程完成。在整个过程中，系统中始终有可以正常工作的Cloud Controller提供服务，因此对用户来说感觉不到系统的停滞。整个过程如下图所示：
<img src="/images/deploy/fig31.png" alt="fig31.png"><img src="/images/deploy/fig32.png" alt="fig32.png"></p>

<p>在DEA结点的更新上，BOSH会给旧版本DEA 中的agent发出一个叫”Drain”(排干)的指令，使DEA可以处理完目前所有的请求，然后才把该DEA下线。该旧版DEA上面的应用会迁移到新版本的DEA实例上继续运行，后续的请求将会转发到这些新版本的DEA实例中。
如果我们要升级运行中的Cloud Foundry实例，可以下载github上面最新的cf-release代码，再执行一次前述的部署过程即可。BOSH会自动比较新旧两个release的代码并且只升级代码变动了的组件。</p>

<p>另一种升级的情况是，如果你对Cloud Foundry的代码进行了修改，需要在修改代码之后重新进行create release的过程。下面的操作发生前我们正在使用的release版本为123.2-dev。</p>

<p>首先我们将DEA代码（cf-release/src/dea/lib/dea/agent.rb）中定义的VERSIOIN常量的值从0.99修改为:</p>

<pre><code>- VERSION = 0.99
+ VERSION = 0.999991
</code></pre>

<p>然后执行:</p>

<p><code>bosh create release --with-tarball --force</code></p>

<p>加–force的原因是因为我们修改了代码，而create release时BOSH会检查本地git库与远程github上的代码相比是否发生了变化，如果有更改，BOSH会提示我们提交修改或者加force选项。</p>

<pre><code>| common                    | 5        |             |
| dea                       | 51.2-dev | new version |
| cloud_controller_ng       | 7.1-dev  |             |
</code></pre>

<p>release成功创建后BOSH标识出了DEA的新版本，并且列出代码更改影响到的job：</p>

<pre><code>+-------+----------+
| Name  | Version  |
+-------+----------+
| dea   | 21       |
+-------+----------+
</code></pre>

<p>同时，我们也可以看到release的版本号增加到了123.3-dev：</p>

<pre><code>Release version: 123.3-dev
Release manifest: /home/bosh/cf-release/dev_releases/cf-dev-123.3-dev.yml
Release tarball (1.5G): /home/bosh/cf-release/dev_releases/cf-dev-123.3-dev.tgz
</code></pre>

<p>接下来我们上传这个新release：
<code>bosh upload release cf-dev-123.3-dev.tgz</code></p>

<p>完成后，查看当前可用的releases：</p>

<pre><code>+--------+------------+
| Name   | Versions   |
+--------+------------+
| cf-dev | 123.3-dev  |
| cf01   | 123.2-dev* |
+--------+------------+
(*) Currently deployed
</code></pre>

<p>然后在我们的cf.yml文件中修改release的版本和名字：</p>

<pre><code>release:
  name: cf-dev
  version: 123.3-dev
</code></pre>

<p>接下来我们就可以执行bosh deploy了，等待部署过程完成后，我们可以使用：</p>

<p><code>bosh ssh dea 0</code> （这里请求的密码是个临时密码，您可以随意设置一个自己记住的值即可）</p>

<p>登录到DEA的虚机中，然后查看下DEA的日志文件（/var/vcap/sys/log/dea/dea.log）的第一句：</p>

<p><code>[2012-12-28 07:46:02.124445] dea - pid=24397 tid=030f fid=3ade   INFO -- Starting VCAP DEA (0.999991)</code></p>

<p>我们可以看到DEA的VERSION信息已经变成了我们自己设置的值0.999991，代码修改生效了。</p>

<p>综合上述，我们看到BOSH不仅可以部署Cloud Foundry，而且可以帮助我们动态监控和调整系统资源，并且可以在线升级系统代码。因此生产系统中都需要使用BOSH来管理和运维Cloud Foundry 平台。</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class='container' id='footer'>
<div class='site-wrap'>
<div class='row'>
<div class='span-3 social-icons'>
<a class='twitter replaced' href='http://e.weibo.com/2169336083/profile' rel='external' target='_blank'>Weibo</a>
<a class='facebook replaced' href='http://cloudfoundry.csdn.net' rel='external' target='_blank'>CSDN</a>
<a class='youtube replaced' href='http://i.youku.com/u/id_UNDI5MTA2Mjk2' rel='external' target='_blank'>YouKu</a>
</div>
<div class='prepend-2 span-5'>
<p>
<!-- %a{:href => "#{url(@config, :www_app)}/faq"} 问题 -->
<a href='http://cndocs.cloudfoundry.com/faq.html'>问题</a>
|
<a href='http://forum.csdn.net/slist/cloudfoundry' rel='external'>论坛</a>
|
<!-- %a{:href => url(@config, :blog_app), :rel => "external"} 博客 -->
<a href='http://cnblog.cloudfoundry.com/' rel='external'>博客</a>
|
<a href='http://www.cloudfoundry.com/jobs'>工作</a>
|
<a href='http://www.cloudfoundry.com/legal'>法律</a>
|
<a href='http://www.cloudfoundry.com/terms'>条款</a>
|
<a href='http://www.vmware.com/help/privacy.html' rel='external' target='_blank'>隐私</a>
</p>
</div>
<div class='span-5 last right'>
<p>Copyright &copy; 2013 VMware, Inc. All rights reserved.</p>
</div>
</div>
</div>
</div>
<script>
  //<![CDATA[
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-22181585-14']);
    _gaq.push(['_trackPageview']);
    
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    /$(document).ready(function() {
     / $('#social-share').dcSocialShare({
      /  buttonSize: 'horizontal',
      / buttons: 'facebook,twitter,plusone,linkedin',
      /  location: 'top',
      /  align: 'right',
      /  offsetLocation: 260,
      /  offsetAlign: 100,
      /  width: 80,
      /  center: true,
      /  centerPx: 600,
      /  disableFloat: true,
      /  tabText: '',
      /  twitterId: 'cloudfoundry'
      /});
    /});
  //]]>
</script>
</body>
</html>
